<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frontend Engine Tests</title>
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
  </head>
  <body>
    <div id="mocha"></div>
    <div id="root" style="display:none"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/chai/chai.js"></script>
    <script src="https://unpkg.com/mocha/mocha.js"></script>
    <script>mocha.setup('bdd'); const { expect } = chai;</script>

    <script type="text/babel" data-presets="env,react" src="../../script.js"></script>

    <script type="text/babel">
      function playMoves(state, moves) {
        let s = cloneState(state);
        for (const uci of moves) {
          const from = uci.slice(0,2);
          const to = uci.slice(2,4);
          const promo = uci.length > 4 ? uci[4] : null;
          const legal = generateLegalFrom(s, from).filter(m => m.to === to);
          if (!legal.length) throw new Error('illegal ' + uci);
          s = applyMove(s, legal[0], promo);
        }
        return s;
      }

      describe('Engine basics', function() {
        it('initial position has legal moves', function() {
          const st = createInitialState();
          const legalE2 = generateLegalFrom(st, 'e2').map(m => m.to);
          expect(legalE2).to.include.members(['e3','e4']);
          const legalG1 = generateLegalFrom(st, 'g1').map(m => m.to);
          expect(legalG1).to.include('f3');
        });

        it('en passant available after double push', function() {
          let st = createInitialState();
          st = playMoves(st, ['e2e4','a7a6','e4e5','d7d5']);
          const targets = generateLegalFrom(st, 'e5').map(m => m.to);
          expect(targets).to.include('d6');
        });

        it('castling king side when path clear and not in check', function() {
          // Simplify: move knight and bishop, then castle.
          let st = createInitialState();
          st = playMoves(st, ['g1f3','g8f6','e2e3','e7e6','f1e2','f8e7']);
          const kingTargets = generateLegalFrom(st, 'e1').map(m => m.to);
          expect(kingTargets).to.include('g1');
        });

        it('promotion flags appear on pawn reaching last rank', function() {
          let st = createInitialState();
          // Drive a white pawn from a2 to a8
          st = playMoves(st, ['a2a4','h7h6','a4a5','h6h5','a5a6','h5h4','a6a7','h4h3']);
          const targets = generateLegalFrom(st, 'a7');
          const promo = targets.find(m => m.to === 'a8' && m.promotion);
          expect(!!promo).to.equal(true);
        });
      });

      mocha.run();
    </script>
  </body>
  </html>

